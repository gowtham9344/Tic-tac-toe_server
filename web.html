<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tic-Tac-Toe Web Client</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
            margin: 20px;
        }

        #game-section {
            display: none;
        }
        
        .board-row:after {
	  clear: both;
	  content: "";
	  display: table;
	}

	.board{
		display:none;
		text-align:center;
	}
        
        .square {
	  background: #fff;
	  border: 1px solid #999;
	  float: left;
	  font-size: 24px;
	  font-weight: bold;
	  line-height: 34px;
	  height: 34px;
	  margin-right: -1px;
	  margin-top: -1px;
	  padding: 0;
	  text-align: center;
	  width: 34px;
	}

	.square:focus {
	  outline: none;
	}

    </style>
    <script>
        let ws;
        let userid;
        let activeUsersList = [];
        let gameRequestsList = [];
        let opuser = 0;
        let moveSymbol = '';
        let contentSplit = [];

        function connect() {

            ws = new WebSocket('ws://10.39.17.247:8000');

            ws.onopen = function (event) {
                document.getElementById('connection-section').style.display = 'none';
                document.getElementById('game-section').style.display = 'block';
            };

            ws.onmessage = function (event) {
                const data = event.data;
                handleWebSocketMessage(data);
            };

            ws.onclose = function (event) {
                console.log('Connection closed');
            };

            ws.onerror = function (event) {
                console.error('WebSocket error:', event);
            };
        }

        function handleWebSocketMessage(data) {
            const parts = data.split(' => ');
            const command = parts[0];
            const content = parts[1];

            switch (command) {
            	 case 'userid':
            	     userid = content;
            	     document.getElementById('user-id').innerHTML = "your user id is " + userid;
            	     break;
                case 'activeUsers':
                    activeUsersList = content.split(', ');
                    if(activeUsersList.length === 1 && activeUsersList[0] === ""){
                    	updateActiveUsersListNoUsers();
                    }
                    else if(activeUsersList.length != 0){
                    	updateActiveUsersList();
                    }
                    break;
                case 'gameRequest':
                    gameRequestsList.push(content);
                    updateGameRequestsList();
                    break;
                case 'gameStart':
                    console.log("hello");
                    defaultboard();
                    contentSplit = content.split(', ');
                    opuser = contentSplit[0];
                    moveSymbol = contentSplit[1];
                    displayGame();
                    
                    break;
                case 'yourTurn':
                    displayYourMove();
                    enablebuttons();
                    break;
                case 'OpponentTurn':
                    displayOpponentMove();
                    disablebuttons();
                    break;
                case 'gameMove':
                    displayMoves(content,moveSymbol == 'x' ? 'o' : 'x');
                    break;
                case 'gameOver':
                    displayWinner(content);
                    console.log(content);
                    opuser = 0;
                    break;
            }
        }
        
        function displayYourMove(){
            const yourMoveElement = document.getElementById('move-details');
            yourMoveElement.innerHTML = 'This is your turn Please select some tile to Move';
        }
        
        function displayMoves(content,Opposymbol){
            makemove(content,Opposymbol);
        }
        
        function displayOpponentMove(){
            const yourMoveElement = document.getElementById('move-details');
            yourMoveElement.innerHTML = `This is opponent turn with user id is ${opuser}. Please wait until he moves`;
        }
        
        function displayGame(){
        	const displayGameElement = document.getElementById('game-board');
        	displayGameElement.style.display = 'block';
        }
        
        function displayWinner(content){
        	const displayGameElement = document.getElementById('move-details');
        	if(content == 0){
        		displayGameElement.innerHTML = "It's is a tie";
        	}
        	else if( userid == content){
        		displayGameElement.innerHTML = 'you are the winner!!!';
        	}
        	else{
        		displayGameElement.innerHTML = 'Better luck next time';
        	}
        	
        	setTimeout(function(){
			const displayGameElement = document.getElementById('move-details');
			displayGameElement.innerHTML = '';
			displayNotGame();
        	},10000);
        }

	function displayNotGame(){
		const displayGameElement = document.getElementById('game-board');
        	displayGameElement.style.display = 'none';
	}
	
        function updateActiveUsersList() {
            const activeUsersElement = document.getElementById('active-users');
            activeUsersElement.innerHTML = '';
            activeUsersList.forEach(user => {
                const listItem = document.createElement('li');
                listItem.textContent = user;
                listItem.onclick = () => sendGameRequest(user);
                activeUsersElement.appendChild(listItem);
            });
        }
        
         function updateActiveUsersListNoUsers() {
            const activeUsersElement = document.getElementById('active-users');
            activeUsersElement.innerHTML = "NoActiveUsers";
        }

        function updateGameRequestsList() {
            const gameRequestsElement = document.getElementById('game-requests');
            gameRequestsElement.innerHTML = '';
            gameRequestsList.forEach(user => {
                const listItem = document.createElement('li');
                listItem.textContent = `${user} has requested a game`;
                listItem.onclick = () => acceptGameRequest(user);
                gameRequestsElement.appendChild(listItem);
            });
        }
        function getActiveUsers(){
            ws.send("activeUsers");
        }

        function sendGameRequest(toUser) {
            ws.send(`gameRequest => ${toUser}`);
        }

        function acceptGameRequest(fromUser) {
            ws.send(`acceptGameRequest => ${fromUser}`);
        }

        function requestGame() {
            ws.send('requestGame');
        }

        function terminateConnection() {
            ws.close();
        }

        function makemove(i,moveName) {
            const gameRequestsElement = document.getElementById(`square${i}`);
            gameRequestsElement.innerHTML = moveName;
            gameRequestsElement.disabled = true;
            if(moveName == moveSymbol){
           	 ws.send(`gameMove => ${i}`);
           	 //disablebuttons();
            }
        }
        
        function enablebuttons(){
        	let i = 0;
        	for(i = 0 ;i < 9;i++){
        		const gameRequestsElement = document.getElementById(`square${i}`);
        		if(gameRequestsElement.innerHTML == ''){
            			gameRequestsElement.disabled = false;
            		}
        	}
        }
        
        function defaultboard(){
        	let i = 0;
        	for(i = 0 ;i < 9;i++){
        		let gameRequestsElement = document.getElementById(`square${i}`);
        		gameRequestsElement.innerHTML = '';
        	}
        }
        
        function disablebuttons(){
        	let i = 0;
        	for(i = 0 ;i < 9;i++){
        		const gameRequestsElement = document.getElementById(`square${i}`);
            		gameRequestsElement.disabled = true;
        	}
        }

    </script>
</head>
<body>
    <div id="connection-section">
        <button onclick="connect()">Connect to join the game pool</button>
    </div>

    <div id="game-section" style="display: none;">
    	<h2  id="user-id" ></h2>
        <h2>1.Active Users</h2>
        <ul id="active-users"></ul>

        <h2>2.Game Requests</h2>
        <ul id="game-requests"></ul>

        
        <div id="game-board" class="board">
        	<h2>3.Game Board</h2>
        	<p id = "move-details" ></p>
		<div class="board-row">
		  <button id="square0" class="square" onclick="makemove(0,moveSymbol)"></button>
		  <button id="square1" class="square" onclick="makemove(1,moveSymbol)"></button>
		  <button id="square2" class="square" onclick="makemove(2,moveSymbol)"></button>
		</div>
		<div class="board-row">
		  <button id="square3" class="square" onclick="makemove(3,moveSymbol)"></button>
		  <button id="square4" class="square" onclick="makemove(4,moveSymbol)"></button>
		  <button id="square5" class="square" onclick="makemove(5,moveSymbol)"></button>
		</div>
		<div class="board-row">
		  <button id="square6" class="square" onclick="makemove(6,moveSymbol)"></button>
		  <button id="square7" class="square" onclick="makemove(7,moveSymbol)"></button>
		  <button id="square8" class="square" onclick="makemove(8,moveSymbol)"></button>
		</div>
        </div>
	<button onclick="getActiveUsers()">Get active users</button>
        <button onclick="requestGame()">Request Game</button>
        <button onclick="terminateConnection()">Terminate Connection</button>
        
    </div>
</body>
</html>

